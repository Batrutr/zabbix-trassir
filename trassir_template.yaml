zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: 7df96b18f2304087ad29bb8bf6f8e6e9
      name: 'Templates/Video surveillance'
  templates:
    - uuid: a571c0d144b54967a915ab6dac3b1f1e
      template: 'TRASSIR Server'
      name: 'TRASSIR Server Monitoring'
      description: 'Мониторинг состояния каналов TRASSIR через SDK API'
      groups:
        - name: 'Templates/Video surveillance'
      items:
        - uuid: 11223344556647889900aabbccddeeff
          name: 'TRASSIR: Channels online'
          type: DEPENDENT
          key: trassir.channels.online
          history: 7d
          description: 'Количество каналов онлайн'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.channels_online
          master_item:
            key: trassir.health
          tags:
            - tag: component
              value: channels
        - uuid: ffeeddccbbaa40998877665544332211
          name: 'TRASSIR: Channels total'
          type: DEPENDENT
          key: trassir.channels.total
          history: 7d
          description: 'Общее количество каналов'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.channels_total
          master_item:
            key: trassir.health
          tags:
            - tag: component
              value: channels
        - uuid: a16371ccf4a741ccb79e556ea58ba62b
          name: 'TRASSIR: CPU load'
          type: DEPENDENT
          key: trassir.cpu.load
          history: 7d
          value_type: FLOAT
          units: '%'
          description: 'Загрузка CPU сервера TRASSIR'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.cpu_load
          master_item:
            key: trassir.health
          tags:
            - tag: component
              value: cpu
          triggers:
            - uuid: 9f845ea9dd044b5da704e0b4b8ee7204
              expression: 'avg(/TRASSIR Server/trassir.cpu.load,30m)>=90'
              name: 'TRASSIR: Critical CPU load (>90% for 30m)'
              priority: HIGH
              description: 'Критическая загрузка CPU на сервере TRASSIR'
        - uuid: a1b2c3d4e5f64718a9384756abcdef01
          name: 'TRASSIR: Server health'
          type: HTTP_AGENT
          key: trassir.health
          delay: 2m
          history: 7d
          value_type: TEXT
          description: 'Состояние здоровья сервера TRASSIR'
          url: '{$TRASSIR.URL}/health'
          posts: 'username={$TRASSIR.USERNAME}&password={$TRASSIR.PASSWORD}'
          request_method: POST
          tags:
            - tag: component
              value: health
        - uuid: f1e2d3c4b5a647868532d1fedcba0987
          name: 'TRASSIR: Get objects list'
          type: HTTP_AGENT
          key: trassir.objects
          delay: 12h
          history: 7d
          value_type: TEXT
          description: 'Получение списка всех объектов сервера TRASSIR'
          url: '{$TRASSIR.URL}/objects/'
          posts: 'username={$TRASSIR.USERNAME}&password={$TRASSIR.PASSWORD}'
          request_method: POST
          tags:
            - tag: component
              value: trassir
      discovery_rules:
        - uuid: 123456789abc4ef092345678abcdef01
          name: 'TRASSIR Channel Discovery'
          type: DEPENDENT
          key: trassir.channel.discovery
          lifetime: 1d
          enabled_lifetime_type: DISABLE_NEVER
          description: 'Автоматическое обнаружение каналов TRASSIR'
          item_prototypes:
            - uuid: 99887766554443229100ffeeddccbbaa
              name: 'Channel [{#CHANNEL.NAME}]: Signal status'
              type: HTTP_AGENT
              key: 'trassir.channel.signal[{#CHANNEL.GUID}]'
              delay: 2m
              history: 7d
              description: 'Статус сигнала канала: 1 - Signal, 0 - No Signal'
              valuemap:
                name: 'Signal status'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.state_vector[0]'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: 'No Signal'
                - type: JAVASCRIPT
                  parameters:
                    - 'return value === "Signal" ? 1 : 0;'
              url: '{$TRASSIR.URL}/objects/{#CHANNEL.GUID}'
              posts: 'username={$TRASSIR.USERNAME}&password={$TRASSIR.PASSWORD}'
              request_method: POST
              tags:
                - tag: channel
                  value: '{#CHANNEL.NAME}'
                - tag: component
                  value: signal
              trigger_prototypes:
                - uuid: fedcba9876544210bedcba9876543210
                  expression: 'last(/TRASSIR Server/trassir.channel.signal[{#CHANNEL.GUID}])=0'
                  name: 'Channel [{#CHANNEL.NAME}]: No signal detected'
                  priority: WARNING
                  description: 'На канале {#CHANNEL.NAME} отсутствует сигнал'
                  manual_close: 'YES'
                  tags:
                    - tag: channel
                      value: '{#CHANNEL.NAME}'
                    - tag: scope
                      value: availability
                - uuid: 3a3b94df70804e8fb54c4c75d803a5a8
                  expression: 'changecount(/TRASSIR Server/trassir.channel.signal[{#CHANNEL.GUID}],1h,"dec")>=3'
                  recovery_mode: RECOVERY_EXPRESSION
                  recovery_expression: |
                    count(/TRASSIR Server/trassir.channel.signal[{#CHANNEL.GUID}],1d,,0)=0
                    and
                    nodata(/TRASSIR Server/trassir.channel.signal[{#CHANNEL.GUID}],1h)=0
                  name: 'Channel [{#CHANNEL.NAME}]: Signal lost 3 times in 1 hour'
                  priority: AVERAGE
                  description: 'На канале {#CHANNEL.NAME} пропадал сигнал 3 раза за 1 час'
                  manual_close: 'YES'
                  tags:
                    - tag: channel
                      value: '{#CHANNEL.NAME}'
                    - tag: scope
                      value: availability
          master_item:
            key: trassir.objects
          lld_macro_paths:
            - lld_macro: '{#CHANNEL.GUID}'
              path: $.guid
            - lld_macro: '{#CHANNEL.NAME}'
              path: $.name
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$[?(@.class=="Channel")]'
        - uuid: ad0abd1f103940e4bf5b2718e195abc1
          name: 'TRASSIR Server Discovery'
          type: DEPENDENT
          key: trassir.server.discovery
          lifetime: 7d
          enabled_lifetime_type: DISABLE_NEVER
          description: 'Автоматическое обнаружение серверов TRASSIR'
          item_prototypes:
            - uuid: cb57cab3bf2d4140bffdf7572bd09512
              name: 'SERVER [{#SERVER.NAME}]: Connection status'
              type: HTTP_AGENT
              key: 'trassir.server.connection[{#SERVER.GUID}]'
              delay: 2m
              history: 7d
              value_type: UNSIGNED
              description: 'Статус подключения к серверу: 1 - Online, 0 - Offline'
              url: '{$TRASSIR.URL}/objects/{#SERVER.GUID}'
              posts: 'username={$TRASSIR.USERNAME}&password={$TRASSIR.PASSWORD}'
              request_method: POST
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.guid
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '0'
                - type: JAVASCRIPT
                  parameters:
                    - 'return value === "{#SERVER.GUID}" ? 1 : 0;'
              tags:
                - tag: component
                  value: connection
                - tag: server
                  value: '{#SERVER.NAME}'
              trigger_prototypes:
                - uuid: 1cb3780b8c824779b4d496ebd8a5da97
                  expression: 'min(/TRASSIR Server/trassir.server.connection[{#SERVER.GUID}],5m)=0'
                  recovery_mode: RECOVERY_EXPRESSION
                  recovery_expression: 'min(/TRASSIR Server/trassir.server.connection[{#SERVER.GUID}],3m)=1'
                  name: 'SERVER [{#SERVER.NAME}]: Connection lost'
                  priority: HIGH
                  description: 'Потеряно подключение к серверу {#SERVER.NAME}'
                  manual_close: 'YES'
                  tags:
                    - tag: server
                      value: '{#SERVER.NAME}'
                    - tag: scope
                      value: availability
          master_item:
            key: trassir.objects
          lld_macro_paths:
            - lld_macro: '{#SERVER.GUID}'
              path: $.guid
            - lld_macro: '{#SERVER.NAME}'
              path: $.name
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$[?(@.class=="Server")]'
      macros:
        - macro: '{$TRASSIR.PASSWORD}'
          value: password
          description: 'Пароль пользователя TRASSIR'
        - macro: '{$TRASSIR.URL}'
          value: 'https://192.168.1.200:8080'
          description: 'URL сервера TRASSIR (например: https://192.168.1.200:8080)'
        - macro: '{$TRASSIR.USERNAME}'
          value: Admin
          description: 'Имя пользователя TRASSIR'
      valuemaps:
        - uuid: abcdef1234564890abcdef1234567890
          name: 'Signal status'
          mappings:
            - value: '0'
              newvalue: 'No Signal'
            - value: '1'
              newvalue: Signal
